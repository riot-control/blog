
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Write your logic with purity - Riot Control</title>
  <meta name="author" content="">

  
  <meta name="description" content="When I first learned about pure functions
I tried to map the concept to a core piece of logic on our product. It was hard,
and I spent some days &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.riot-control.net/2014/04/29/write-your-logic-with-purity">
  <link href="/blog/favicon.ico" rel="icon">
  
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="/blog/javascripts/ender.js"></script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/blog/atom.xml" rel="alternate" title="Riot Control" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-45179678-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="no-sidebar"  >
  <header role="banner"><hgroup>
  <h1>Riot Control</h1>
  
</hgroup>

</header>
  <nav role="navigation">
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.riot-control.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Write Your Logic With Purity</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-29T00:00:00+01:00" pubdate data-updated="true">Apr 29<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>When I first learned about <a href="http://www.riot-control.net/2014/04/10/pure-functions/">pure functions</a>
I tried to map the concept to a core piece of logic on our product. It was hard,
and I spent some days figuring it out. The test functionality is an invoice
finalizer. We first had all that logic on the fat models, and then we refactored
it to <a href="/blog/2013/12/03/the-almighty-interactor/">interactors</a>
and it was a huge improvement. Even so, all the <em>gateway</em> logic and such, seamed
like an unnecessary burden. This functionality, in ruby, is something like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">FinalizeDocument</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:document</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">run</span>
</span><span class='line'>    <span class="n">lock</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">sequence</span> <span class="o">=</span> <span class="n">find_sequence</span>
</span><span class='line'>      <span class="n">document</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">increment</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">last_document</span><span class="p">)</span>
</span><span class='line'>      <span class="n">validate_document</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">document</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;final&#39;</span>
</span><span class='line'>      <span class="n">document</span><span class="o">.</span><span class="n">final_date</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">document</span><span class="o">.</span><span class="n">calculate_totals</span>
</span><span class='line'>      <span class="n">document</span><span class="o">.</span><span class="n">sign_and_do_crypto_things</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">document</span><span class="o">.</span><span class="n">save!</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<!-- more -->


<p>A gateway object is used as an indirection to load and persist the required data,
and having this indirection enables us to test the interactor using memory objects,
instead of hitting the database. We are not coupled with a particular form of
persistence, but we are still coupled with the persistence operations. Do we
really need this? Or is it possible to remove the use of the gateway altogether?</p>

<p>A <em>pure function</em> doesn&rsquo;t mutate objects, and doesn&rsquo;t do IO. Our current version
relies heavily on mutating and IO. Using a pure function feels like improving
the code, but it doesn&rsquo;t seems possible on this scenario. I had to reset my way
of thinking to reach something that, at this moment, seems logical.</p>

<p>The turning point was when I started to say things differently. I don&rsquo;t want
a function that finalizes an invoice. I want a function that when given a
draft invoice, returns a version of that invoice as finalized. On scala, it
could be something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Document</span><span class="o">(</span><span class="n">number</span> <span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">status</span> <span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="o">...)</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">DocumentItem</span><span class="o">(</span><span class="n">unitPrice</span> <span class="k">:</span> <span class="kt">Double</span><span class="o">,</span> <span class="n">quantity</span> <span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="o">...)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">finalize</span><span class="o">(</span><span class="n">draft</span><span class="k">:</span><span class="kt">Document</span><span class="o">,</span> <span class="n">previous</span><span class="k">:</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Document</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">v1</span> <span class="k">=</span> <span class="n">buildSequence</span><span class="o">(</span><span class="n">draft</span><span class="o">,</span> <span class="n">previous</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">v2</span> <span class="k">=</span> <span class="n">calculateTotals</span><span class="o">(</span><span class="n">v1</span><span class="o">)</span>
</span><span class='line'>  <span class="n">signData</span><span class="o">(</span><span class="n">v2</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using functional programming in scala, we could split all this and build the
<code>finalize</code> function as a composition of the other inner functions. All these
inner functions are also pure an can be unit tested on the side. This is a very
nice way to have independent, easily tested logic.</p>

<p>However, we have the logic, but still don&rsquo;t have the functionality. We aren&rsquo;t
persisting anything, so this function doesn&rsquo;t provide us with the side effects
that we want. The thing is, a program can&rsquo;t be solely composed of pure functions,
or else it wouldn&rsquo;t do anything useful. We can however, use our simple and
easily tested pure function that finalizes a document to implement this
functionality.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">finalizeInvoice</span><span class="o">(</span><span class="n">draftId</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">lock</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">draft</span> <span class="k">=</span> <span class="n">loadDraft</span><span class="o">(</span><span class="n">draftId</span><span class="o">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">previous</span> <span class="k">=</span> <span class="n">loadPrevious</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">finalized</span> <span class="k">=</span> <span class="n">finalize</span><span class="o">(</span><span class="n">draft</span><span class="o">,</span> <span class="n">previous</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">saveDocument</span><span class="o">(</span><span class="n">finalized</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is a better way. We can have all the logic tested and on a module that
doesn&rsquo;t depend on ORMs, web frameworks, etc. And we can have another module
that puts everything together. I believe that this is the best approach for
building software and it&rsquo;s great for TDD.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/blog/about" title="About the author (donbonifacio)" rel="author">donbonifacio</a></span></span>

      








  


<time datetime="2014-04-29T00:00:00+01:00" pubdate data-updated="true">Apr 29<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/software-development/'>software development</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.riot-control.net/2014/04/29/write-your-logic-with-purity/" data-via="" data-counturl="http://www.riot-control.net/2014/04/29/write-your-logic-with-purity/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/04/24/what-takes-to-be-a-great-leader/" title="Previous Post: What it takes to be a great leader?">&laquo; What it takes to be a great leader?</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/05/23/why-good-leaders-make-you-feel-safe/" title="next Post: Why good leaders make you feel safe">Why good leaders make you feel safe &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 -  -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'riot-control';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.riot-control.net/2014/04/29/write-your-logic-with-purity/';
        var disqus_url = 'http://www.riot-control.net/2014/04/29/write-your-logic-with-purity/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
